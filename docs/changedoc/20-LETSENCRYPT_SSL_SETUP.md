# Change Documentation: Let's Encrypt SSL Certificate Setup

**Date**: November 24, 2025  
**Author**: Development Team  
**Status**: Complete  
**Related Issues**: HTTPS support for localhost and production domains

## Purpose

Implement comprehensive SSL/TLS certificate support for the UTM Backend application, supporting both local development (self-signed certificates) and production deployment (Let's Encrypt certificates).

## Summary

Added full HTTPS support with automatic SSL certificate management:

- **Self-signed certificates** for localhost development
- **Let's Encrypt certificates** for production domains (e.g., rex.stage.fauda.dream11.in)
- Automated certificate renewal via Certbot
- HTTP to HTTPS automatic redirection
- Security headers and modern TLS configuration

## Changes Made

### 1. Docker Compose Configuration

Updated `docker-compose.yml`:

```yaml
# Added HTTPS support to nginx
nginx:
  ports:
    - "80:80"
    - "443:443"  # NEW: HTTPS port
  volumes:
    - ./ssl:/etc/nginx/ssl:ro  # NEW: Self-signed certificates
    - certbot_conf:/etc/letsencrypt:ro  # NEW: Let's Encrypt certificates
    - certbot_www:/var/www/certbot:ro  # NEW: ACME challenge directory

# NEW: Certbot service for Let's Encrypt
certbot:
  image: certbot/certbot:latest
  container_name: utm-certbot
  volumes:
    - certbot_conf:/etc/letsencrypt
    - certbot_www:/var/www/certbot
  entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

# NEW: Certificate volumes
volumes:
  certbot_conf:
  certbot_www:
```

### 2. Nginx Configuration

Complete rewrite of `nginx.conf` to support HTTPS:

#### HTTP Server (Port 80)
- Serves Let's Encrypt ACME challenges
- Redirects all other traffic to HTTPS
- Allows health check endpoint for monitoring

#### HTTPS Server (Port 443)
- SSL/TLS termination with modern configuration
- Supports both self-signed (localhost) and Let's Encrypt certificates
- Security headers (HSTS, X-Frame-Options, etc.)
- Proxies to backend API and frontend
- WebSocket support for Vite HMR

#### Security Improvements
- TLS 1.2 and 1.3 only
- Strong cipher suites
- HTTP Strict Transport Security (HSTS)
- Protection against clickjacking and XSS

### 3. SSL Directory Structure

```
utm-backend/
â”œâ”€â”€ ssl/                          # Self-signed certificates (localhost)
â”‚   â”œâ”€â”€ cert.pem                 # Generated by setup script
â”‚   â””â”€â”€ key.pem                  # Generated by setup script
â””â”€â”€ [docker volumes]
    â”œâ”€â”€ certbot_conf/             # Let's Encrypt certificates
    â””â”€â”€ certbot_www/              # ACME challenge files
```

### 4. Setup Scripts

Created three management scripts:

#### `scripts/setup-ssl-localhost.sh`
- Generates self-signed certificates for local development
- Valid for 365 days
- Supports localhost, *.localhost, and 127.0.0.1
- Provides instructions for trusting certificates

#### `scripts/setup-ssl-letsencrypt.sh`
- Requests Let's Encrypt certificates for production domains
- Validates domain accessibility
- Automatically updates nginx.conf
- Zero-downtime certificate issuance (webroot method)
- Comprehensive error handling

#### `scripts/manage-ssl.sh`
- Interactive menu for SSL management
- Check certificate status
- Renew certificates
- Test HTTPS connections
- View nginx SSL configuration

### 5. Security Configuration

Added to `.gitignore`:
```
/ssl/*.pem
```

This prevents accidentally committing private keys to version control.

## Usage

### For Local Development (Localhost)

1. **Setup** (already done during installation):
   ```bash
   ./scripts/setup-ssl-localhost.sh
   ```

2. **Start services**:
   ```bash
   docker-compose up -d
   ```

3. **Access via HTTPS**:
   - Frontend: https://localhost
   - API: https://localhost/api
   - Health: https://localhost/health

4. **Browser warning**: Accept the self-signed certificate warning (normal for development)

### For Production Domain (rex.stage.fauda.dream11.in)

1. **Prerequisites**:
   - Domain must point to your server's IP
   - Port 80 and 443 must be accessible from internet
   - Docker services must be running

2. **Request certificate**:
   ```bash
   ./scripts/setup-ssl-letsencrypt.sh rex.stage.fauda.dream11.in your-email@example.com
   ```

3. **Automatic updates**:
   - Script updates nginx.conf automatically
   - Reloads nginx with new certificate
   - Sets up automatic renewal (every 12 hours)

4. **Access via HTTPS**:
   - https://rex.stage.fauda.dream11.in
   - No browser warnings!

### Certificate Management

Use the interactive management tool:

```bash
./scripts/manage-ssl.sh
```

Options:
1. Setup localhost (self-signed)
2. Setup Let's Encrypt (production)
3. Check certificate status
4. Renew certificates
5. Test HTTPS connection
6. View nginx SSL configuration

## Certificate Renewal

### Self-Signed Certificates (Localhost)
- Valid for 365 days
- Regenerate when expired: `./scripts/setup-ssl-localhost.sh`

### Let's Encrypt Certificates (Production)
- Valid for 90 days
- **Automatic renewal** via certbot container
- Checks every 12 hours
- Renews 30 days before expiry
- Manual renewal: `docker-compose run --rm certbot renew`

## Testing

### Test HTTP to HTTPS Redirect

```bash
curl -I http://localhost/
# Expected: 301 Moved Permanently
# Location: https://localhost/
```

### Test HTTPS Connection

```bash
# Localhost (self-signed)
curl -k https://localhost/health
# Expected: healthy

# Production domain
curl https://rex.stage.fauda.dream11.in/health
# Expected: healthy (no -k flag needed)
```

### Test Certificate Details

```bash
# Check certificate info
openssl s_client -connect localhost:443 -servername localhost < /dev/null 2>/dev/null | \
  openssl x509 -noout -text

# Check expiry date
echo | openssl s_client -connect localhost:443 2>/dev/null | \
  openssl x509 -noout -dates
```

### Test Security Headers

```bash
curl -k -I https://localhost/api | grep -E "(Strict-Transport|X-Frame|X-Content)"
```

Expected headers:
- `Strict-Transport-Security: max-age=31536000; includeSubDomains`
- `X-Frame-Options: SAMEORIGIN`
- `X-Content-Type-Options: nosniff`

## Frontend Updates

Update your frontend environment variables to use HTTPS:

```javascript
// For localhost development
VITE_API_BASE_URL=https://localhost

// For production
VITE_API_BASE_URL=https://rex.stage.fauda.dream11.in
```

SuperTokens configuration:

```javascript
SuperTokens.init({
  appInfo: {
    apiDomain: "https://localhost",  // or your production domain
    websiteDomain: "https://localhost",
    apiBasePath: "/api/v1/auth",
  },
  // ...
});
```

## Troubleshooting

### Issue: Browser shows "Your connection is not private"

**For localhost:**
- This is expected with self-signed certificates
- Click "Advanced" â†’ "Proceed to localhost (unsafe)"
- Or add certificate to system trust store (see script output)

**For production domain:**
- Certificate may not be installed yet
- Run: `./scripts/setup-ssl-letsencrypt.sh YOUR_DOMAIN`
- Check certificate: `docker-compose run --rm certbot certificates`

### Issue: Let's Encrypt request fails

**Check domain accessibility:**
```bash
# Domain should return HTTP 200/301/404 (not connection refused)
curl -I http://rex.stage.fauda.dream11.in/.well-known/acme-challenge/test
```

**Check DNS:**
```bash
dig +short rex.stage.fauda.dream11.in
# Should return your server's IP
```

**Check nginx logs:**
```bash
docker-compose logs nginx
```

**Common causes:**
- Domain doesn't point to server IP
- Firewall blocking port 80
- Nginx not running
- Security group not allowing HTTP traffic

### Issue: Certificate expired

**Let's Encrypt certificates:**
```bash
# Check renewal logs
docker-compose logs certbot | grep -i renew

# Force renewal
docker-compose run --rm certbot renew --force-renewal
docker-compose exec nginx nginx -s reload
```

**Self-signed certificates:**
```bash
# Regenerate
./scripts/setup-ssl-localhost.sh
docker-compose restart nginx
```

### Issue: Nginx fails to start after SSL setup

**Check configuration:**
```bash
docker-compose exec nginx nginx -t
```

**Common causes:**
- Certificate files missing
- Wrong certificate paths in nginx.conf
- Permissions on certificate files

**Fix:**
```bash
# Verify certificates exist
ls -la ssl/cert.pem ssl/key.pem

# Or check Let's Encrypt certs
docker-compose run --rm certbot certificates

# Restart nginx
docker-compose restart nginx
```

## Security Considerations

### Production Checklist

- âœ… HTTPS enabled with Let's Encrypt
- âœ… HTTP to HTTPS automatic redirect
- âœ… HSTS header enabled (1 year)
- âœ… Security headers configured
- âœ… TLS 1.2+ only (no SSL, no TLS 1.0/1.1)
- âœ… Strong cipher suites
- âœ… Automatic certificate renewal
- âœ… Private keys not committed to git

### Additional Recommendations

**For production environments:**

1. **Enable HSTS preload** (after testing):
   ```nginx
   add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
   ```

2. **Enable OCSP Stapling**:
   ```nginx
   ssl_stapling on;
   ssl_stapling_verify on;
   ssl_trusted_certificate /etc/letsencrypt/live/DOMAIN/chain.pem;
   ```

3. **Use TLS 1.3 only** (if browser compatibility allows):
   ```nginx
   ssl_protocols TLSv1.3;
   ```

4. **Set up monitoring**:
   - CloudWatch alarms for certificate expiry
   - Monitor certbot renewal logs
   - Alert on nginx errors

5. **Regular backups**:
   ```bash
   # Backup Let's Encrypt certificates
   docker run --rm -v certbot_conf:/certs -v $(pwd):/backup alpine \
     tar czf /backup/letsencrypt-backup.tar.gz /certs
   ```

## Files Changed

### Modified Files
- `docker-compose.yml` - Added certbot service, HTTPS ports, certificate volumes
- `nginx.conf` - Complete rewrite for HTTPS support
- `.gitignore` - Added SSL certificate exclusions

### New Files
- `ssl/cert.pem` - Self-signed certificate (localhost)
- `ssl/key.pem` - Self-signed private key (localhost)
- `scripts/setup-ssl-localhost.sh` - Self-signed certificate setup
- `scripts/setup-ssl-letsencrypt.sh` - Let's Encrypt certificate setup
- `scripts/manage-ssl.sh` - Interactive SSL management tool

### New Directories
- `ssl/` - Self-signed certificates for localhost
- Docker volumes: `certbot_conf`, `certbot_www`

## Migration Notes

### Existing Installations

If you have an existing installation:

1. **Pull latest changes**:
   ```bash
   git pull origin main
   ```

2. **Generate localhost certificates**:
   ```bash
   ./scripts/setup-ssl-localhost.sh
   ```

3. **Update docker-compose**:
   ```bash
   docker-compose down
   docker-compose up -d
   ```

4. **Update frontend URLs** to use `https://` instead of `http://`

5. **For production**, run Let's Encrypt setup:
   ```bash
   ./scripts/setup-ssl-letsencrypt.sh YOUR_DOMAIN YOUR_EMAIL
   ```

### No Breaking Changes

- HTTP still works (redirects to HTTPS)
- Existing API endpoints unchanged
- Cookie-based auth still works
- Database connections unchanged

## Performance Impact

### Positive Impacts
- âœ… HTTP/2 support (faster page loads)
- âœ… Browser caching improvements
- âœ… Security trust indicators

### Minimal Overhead
- SSL/TLS handshake: ~50-100ms (first request only)
- Encryption overhead: <5% CPU
- Session resumption enabled (subsequent requests fast)

### No Changes To
- Database performance
- API response times (internal HTTP)
- Background job processing

## Cost Impact

**Additional Costs: $0**

- Let's Encrypt: Free
- Certbot: Free, open-source
- Self-signed certificates: Free
- nginx SSL: No additional cost
- Certificate renewal: Automated, no manual work

## Related Documentation

- [NGINX Proxy Guide](../NGINX_PROXY_GUIDE.md) - General nginx configuration
- [AWS Deployment Guide](../AWS_DEPLOYMENT_GUIDE.md) - Production deployment
- [Quickstart Guide](../QUICKSTART.md) - Updated with HTTPS instructions
- [18-NGINX_REVERSE_PROXY_HTTPS.md](./18-NGINX_REVERSE_PROXY_HTTPS.md) - Related nginx HTTPS work

## Next Steps

1. âœ… Update README.md with HTTPS URLs
2. âœ… Update docs/INDEX.md with this document
3. ðŸ”„ Test with actual production domain
4. ðŸ”„ Update frontend environment configurations
5. ðŸ”„ Set up monitoring for certificate expiry
6. ðŸ”„ Document custom domain setup process

## Testing Checklist

- [x] Self-signed certificates generate successfully
- [x] Localhost HTTPS works (with security warning)
- [x] HTTP to HTTPS redirect works
- [x] Health check accessible via HTTPS
- [x] API endpoints work via HTTPS
- [x] Security headers present
- [ ] Let's Encrypt certificate request works (requires domain)
- [ ] Automatic renewal works (test after 90 days)
- [x] Certificate management script works
- [x] nginx configuration valid

## References

- [Let's Encrypt Documentation](https://letsencrypt.org/docs/)
- [Certbot Documentation](https://certbot.eff.org/docs/)
- [Mozilla SSL Configuration Generator](https://ssl-config.mozilla.org/)
- [nginx SSL/TLS Best Practices](https://nginx.org/en/docs/http/configuring_https_servers.html)

---

**Last Updated**: November 24, 2025  
**Tested On**: macOS (Apple Silicon), Docker Desktop  
**Nginx Version**: alpine (latest)  
**Certbot Version**: latest

